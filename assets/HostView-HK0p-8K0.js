import{h as X,i as A,j as g,o as x,c as b,a as e,n as G,t as f,e as oe,k as Q,b as S,w as ae,l as q,v as J,m as le,p as M,u as v,d as K,F as ne,f as re,r as ie,q as ue,s as ce}from"./index-BaALbLir.js";import{u as de}from"./useVotingConfig-UX6My9AV.js";import{C as $,u as ve,M as y,$ as pe,c as me,_ as ge,a as ye,R as fe,H as xe}from"./ResultChart-CKQcXMc1.js";function be(){const h="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let p="";for(let i=0;i<3;i++)p+=h.charAt(Math.floor(Math.random()*h.length));p+="-";for(let i=0;i<3;i++)p+=h.charAt(Math.floor(Math.random()*h.length));return p}function he(h,p=null,i=null){const n=g(null),c=g(p||be()),C=A(()=>i?`${i}-${c.value}`:c.value),u=g($.DISCONNECTED),m=g(new Map),_=g(new Map),l=ve(),T=A(()=>{const s=m.value.size,o=l.participantCount.value,r=s+o;return console.log(`[Host] participantCount: ${r} (${s} direct + ${o} via relays)`),r}),w=A(()=>_.value.size),V=A(()=>{const s={},o=h.value;return!o||!o.options||(o.options.forEach(r=>{s[r.label]=0}),_.value.forEach(r=>{s[r]!==void 0&&s[r]++})),s}),O=(s=null)=>new Promise((o,r)=>{try{s&&(c.value=s),u.value=$.CONNECTING,n.value=new pe(C.value,{debug:2}),n.value.on("open",t=>{console.log("Host peer opened with ID:",t),u.value=$.CONNECTED,o(t)}),n.value.on("connection",t=>{console.log("Participant connected:",t.peer),t.on("open",()=>{if(console.log(`Connection to ${t.peer} is now open`),l.canAddRelay.value)console.log(`Assigning relay role to peer ${t.peer}`),l.assignRelayRole(t.peer,t,`Relay-${t.peer.substring(0,8)}`),m.value.set(t.peer,t);else{const P=l.assignParticipantToRelay(t.peer,`User-${t.peer.substring(0,8)}`);P?(console.log(`Assigning peer ${t.peer} to relay ${P}`),t.send({type:y.RELAY_INFO,payload:{relayId:P,shouldConnectViaRelay:!0}})):(console.log(`Peer ${t.peer} connecting directly (no relay available)`),m.value.set(t.peer,t))}}),t.on("data",k=>{L(t.peer,k)}),t.on("close",()=>{console.log("Participant disconnected:",t.peer);const k=l.participants.value.get(t.peer);if(k&&k.relayId){console.log(`Participant ${t.peer} closed direct connection (using relay ${k.relayId})`),m.value.delete(t.peer);return}m.value.delete(t.peer),_.value.delete(t.peer);const I=l.handleRelayDisconnect(t.peer);I&&(I.redistributed||I.failed)?(console.log(`Relay disconnected: ${I.redistributed?.length||0} will reconnect, ${I.failed?.length||0} lost`),I.failed&&I.failed.length>0&&I.failed.forEach(W=>{_.value.delete(W)})):l.handleParticipantDisconnect(t.peer),E()}),t.on("error",k=>{console.error("Connection error:",k)})}),n.value.on("error",t=>{console.error("Peer error:",t),u.value=$.ERROR,r(t)})}catch(t){u.value=$.ERROR,r(t)}}),L=(s,o)=>{switch(console.log("Received message from",s,":",o),o.type){case y.VOTE:case y.VOTE_UPDATE:_.value.set(s,o.vote),E();break;case y.REQUEST_STATE:F(s);break;case y.RELAY_FORWARD:D(o.payload);break;case y.RELAY_HEARTBEAT:l.updateRelayHeartbeat(s);break;case y.RELAY_PARTICIPANT_CONNECTED:H(s,o.payload);break}},D=s=>{const{originalMessage:o,fromPeerId:r}=s;switch(o.type){case y.VOTE:case y.VOTE_UPDATE:_.value.set(r,o.vote),E();break;case y.REQUEST_STATE:z(r);break}},H=(s,o)=>{const{originalPeerId:r,relayPeerId:t}=o;console.log(`[Host] Relay ${s} reports PeerID change: ${r} -> ${t}`),l.replaceParticipantPeerId(s,r,t),E()},E=()=>{const s={type:y.STATE_UPDATE,participantCount:T.value,voteCount:w.value};m.value.forEach(o=>{o.open&&o.send(s)}),l.broadcastViaRelays(s)},N=(s,o)=>{const r={type:y.TIMER_UPDATE,timeRemaining:s,isActive:o};m.value.forEach(t=>{t.open&&t.send(r)}),l.broadcastViaRelays(r)},B=()=>{const s={type:y.TIMER_START};m.value.forEach(o=>{o.open&&o.send(s)}),l.broadcastViaRelays(s)},F=s=>{const o=m.value.get(s);o&&o.open&&o.send({type:y.STATE_UPDATE,participantCount:T.value,voteCount:w.value})},z=s=>{const o={type:y.STATE_UPDATE,participantCount:T.value,voteCount:w.value};l.sendViaRelay(s,o)},j=()=>{const s={type:y.RESULTS,results:V.value,totalVotes:w.value};console.log("Broadcasting results:",s),m.value.forEach(o=>{o.open&&o.send(s)}),l.broadcastViaRelays(s)},Y=()=>{_.value.clear();const s={type:y.RESET,timestamp:Date.now()};m.value.forEach(o=>{o.open&&o.send(s)}),l.broadcastViaRelays(s)},U=()=>{n.value&&(n.value.destroy(),n.value=null),m.value.clear(),_.value.clear(),l.reset(),u.value=$.DISCONNECTED};return X(()=>{U()}),{peer:n,roomId:c,connectionStatus:u,peers:m,votes:_,participantCount:T,voteCount:w,results:V,initHost:O,broadcastResults:j,broadcastState:E,broadcastTimer:N,broadcastTimerStart:B,reset:Y,destroy:U,relayNetwork:l}}function _e(h){const p=g(h),i=g(!1),n=g(!1);let c=null;const C=()=>{i.value||(i.value=!0,p.value=h,c=setInterval(()=>{p.value--,p.value<=0&&u()},1e3))},u=()=>{i.value=!1,n.value=!0,c&&(clearInterval(c),c=null)},m=()=>{i.value=!1,n.value=!1,p.value=h,c&&(clearInterval(c),c=null)};return X(()=>{c&&clearInterval(c)}),{timeRemaining:p,isActive:i,isComplete:n,start:C,reset:m}}const Re=me("rotate-ccw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),Ce={class:"card"},Te={class:"flex gap-3"},we=["value"],Ee={__name:"ShareLink",props:{url:{type:String,required:!0}},setup(h){const p=h,i=g(!1),n=C=>{C.target.select()},c=async()=>{try{await navigator.clipboard.writeText(p.url),i.value=!0,setTimeout(()=>{i.value=!1},2e3)}catch(C){console.error("Failed to copy:",C)}};return(C,u)=>(x(),b("div",Ce,[u[0]||(u[0]=e("h3",{class:"text-lg font-semibold mb-4"},"Share Voting Link",-1)),e("div",Te,[e("input",{type:"text",value:h.url,readonly:"",class:"flex-1 bg-vs-dark border border-vs-border rounded-lg px-4 py-3 text-vs-text font-mono text-sm",onClick:n},null,8,we),e("button",{onClick:c,class:G(["btn-primary whitespace-nowrap",{"opacity-50":i.value}])},f(i.value?"âœ“ Copied":"Copy"),3)]),u[1]||(u[1]=e("p",{class:"text-vs-text-muted text-sm mt-3"}," Share this link with all participants ",-1))]))}},ke={class:"min-h-screen bg-vs-dark p-8"},Ie={class:"max-w-5xl mx-auto"},Ae={key:0,class:"text-center py-12"},Se={key:1,class:"card text-center py-8"},Pe={class:"text-red-400 mb-4"},$e={key:2,class:"space-y-6"},Ve={class:"mb-8"},Ne={class:"text-3xl font-bold mb-2"},De={class:"text-vs-text-muted"},Ue={class:"card max-w-2xl mx-auto"},Me={class:"space-y-6"},Oe={class:"space-y-3"},Le={class:"flex items-center space-x-3 cursor-pointer hover:bg-gray-800 p-3 rounded-lg transition-colors"},He={class:"space-y-3"},Be={class:"flex items-center space-x-3 cursor-pointer hover:bg-gray-800 p-3 rounded-lg transition-colors"},Fe={key:0,class:"ml-11 mt-3"},ze={key:0,class:"text-red-400 text-sm mt-2"},je={class:"pt-4"},Ye=["disabled"],We={key:3},qe={class:"mb-8"},Ge={class:"flex items-center justify-between mb-4"},Ze={class:"text-3xl font-bold mb-2"},Qe={class:"text-vs-text-muted"},Je={class:"text-sm text-vs-text-muted"},Ke={class:"font-mono text-vs-bar-accent"},Xe={class:"space-y-6"},et={class:"card"},tt={class:"flex items-center justify-between"},st={class:"text-3xl font-bold text-vs-bar-accent"},ot={key:0},at={key:1,class:"text-center"},lt=["disabled"],nt={class:"text-vs-text-muted text-sm mt-2"},rt={key:0,class:"card bg-blue-900/20 border border-blue-500/30"},it={class:"flex items-center justify-between mb-4"},ut={class:"text-right"},ct={class:"text-2xl font-bold text-blue-400"},dt={class:"grid grid-cols-1 md:grid-cols-3 gap-3"},vt={class:"flex items-center justify-between mb-2"},pt={class:"text-sm font-medium text-blue-300"},mt={class:"text-vs-text-muted text-xs"},gt={class:"w-full bg-gray-700 rounded-full h-1.5 mt-2"},yt={key:1,class:"space-y-6"},ft={class:"card"},xt={class:"text-center"},bt={key:2,class:"text-center"},ht={key:3,class:"card text-center py-12"},_t={class:"flex justify-center mb-4"},wt={__name:"HostView",props:{votingId:{type:String,required:!0}},setup(h){const p=h;ue();const{loadVoting:i}=de(),n=g(null),c=g(!0),C=g(null),u=g(!1),m=g(!1),_=g(!1),l=g("random"),T=g(""),w=g("");oe(async()=>{try{n.value=await i(p.votingId),c.value=!1}catch(d){C.value=d.message||"Fehler beim Laden des Votings",c.value=!1}});const V=A(()=>{if(l.value==="random")return!0;const d=T.value.trim();return/^[A-Z0-9]{3}-[A-Z0-9]{3}$/.test(d)}),O=()=>{let d=T.value.toUpperCase().replace(/[^A-Z0-9-]/g,"");d.length>=3&&d[3]!=="-"&&(d=d.slice(0,3)+"-"+d.slice(3)),T.value=d.slice(0,7),T.value.length>0&&!V.value?w.value="Format: ABC-123 (3 characters, hyphen, 3 characters)":w.value=""},L=async()=>{if(!_.value){_.value=!0;try{const d=l.value==="custom"?T.value.trim():null;await F(d),m.value=!0}catch(d){C.value="Failed to create room: "+d.message}finally{_.value=!1}}},{roomId:D,connectionStatus:H,participantCount:E,voteCount:N,results:B,initHost:F,broadcastResults:z,broadcastTimer:j,broadcastTimerStart:Y,reset:U,relayNetwork:s}=he(A(()=>n.value),null,p.votingId),o=A(()=>n.value?.delaySeconds||30),{timeRemaining:r,isActive:t,isComplete:k,start:P,reset:I}=_e(o.value);Q(r,d=>{t.value&&j(d,!0)});const W=()=>{!t.value&&!u.value&&(console.log("Manually starting timer"),P(),Y())};Q(k,d=>{d&&!u.value&&(console.log("Timer complete, revealing results"),u.value=!0,z())});const ee=A(()=>typeof window>"u"?"":`${window.location.origin+"/VSMeter/"}vote/${p.votingId}/${D.value}`),Z=()=>{confirm("Are you sure you want to reset the voting? All current votes will be lost.")&&(u.value=!1,I(),U())};return(d,a)=>{const te=ie("router-link");return x(),b("div",ke,[e("div",Ie,[c.value?(x(),b("div",Ae,[...a[3]||(a[3]=[e("div",{class:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-vs-bar-mid"},null,-1),e("p",{class:"mt-4 text-vs-text-muted"},"Loading voting...",-1)])])):C.value?(x(),b("div",Se,[e("p",Pe,f(C.value),1),S(te,{to:"/",class:"btn-secondary"},{default:ae(()=>[...a[4]||(a[4]=[K(" Back to Home ",-1)])]),_:1})])):m.value?(x(),b("div",We,[e("header",qe,[e("div",Ge,[e("div",null,[e("h1",Ze,f(n.value?.title||"Loading..."),1),e("p",Qe,f(n.value?.description),1)]),S(ge,{status:v(H)},null,8,["status"])]),e("div",Je,[a[10]||(a[10]=K(" Room: ",-1)),e("span",Ke,f(v(D)),1)])]),e("div",Xe,[S(Ee,{url:ee.value},null,8,["url"]),e("div",et,[e("div",tt,[e("div",null,[a[11]||(a[11]=e("h3",{class:"text-lg font-semibold mb-2"},"Participants",-1)),e("p",st,f(v(N))+" of "+f(v(E)),1),a[12]||(a[12]=e("p",{class:"text-vs-text-muted text-sm mt-1"},"have voted",-1))]),v(t)&&!u.value?(x(),b("div",ot,[S(ye,{seconds:v(r),message:"until results visible"},null,8,["seconds"])])):!v(t)&&!u.value?(x(),b("div",at,[e("button",{onClick:W,class:"btn-primary",disabled:v(E)===0}," Start Voting ",8,lt),e("p",nt,f(v(E)===0?"Waiting for participants...":`${v(E)} participants connected`),1)])):M("",!0)])]),v(s)?.relayCount.value>0?(x(),b("div",rt,[e("div",it,[a[14]||(a[14]=e("div",null,[e("h3",{class:"text-lg font-semibold text-blue-400"},"Relay Network Active"),e("p",{class:"text-vs-text-muted text-sm"},"Scaling beyond direct P2P limits")],-1)),e("div",ut,[e("p",ct,f(v(s).relayCount.value),1),a[13]||(a[13]=e("p",{class:"text-vs-text-muted text-sm"},"active relays",-1))])]),e("div",dt,[(x(!0),b(ne,null,re(v(s).relayStats.value,(R,se)=>(x(),b("div",{key:R.relayId,class:"bg-gray-800/50 rounded-lg p-3"},[e("div",vt,[e("span",pt,"Relay "+f(se+1),1),e("span",{class:G(["text-xs px-2 py-1 rounded-full",R.loadPercentage<70?"bg-green-900 text-green-300":R.loadPercentage<90?"bg-yellow-900 text-yellow-300":"bg-red-900 text-red-300"])},f(R.loadPercentage)+"% load ",3)]),e("div",mt,f(R.participantCount)+"/"+f(R.capacity)+" participants ",1),e("div",gt,[e("div",{class:G(["h-1.5 rounded-full transition-all duration-300",R.loadPercentage<70?"bg-green-500":R.loadPercentage<90?"bg-yellow-500":"bg-red-500"]),style:ce({width:`${R.loadPercentage}%`})},null,6)])]))),128))])])):M("",!0),u.value?(x(),b("div",yt,[e("div",ft,[a[15]||(a[15]=e("h2",{class:"text-2xl font-bold mb-6 text-center"},"Results",-1)),S(fe,{options:n.value.options,results:v(B),totalVotes:v(N)},null,8,["options","results","totalVotes"])]),e("div",xt,[e("button",{onClick:Z,class:"bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 inline-flex items-center gap-2"},[S(v(Re),{size:20,"stroke-width":2}),a[16]||(a[16]=e("span",null,"Reset Voting & Start New Round",-1))]),a[17]||(a[17]=e("p",{class:"text-vs-text-muted text-sm mt-2"}," This will clear all votes and start a new voting session ",-1))])])):v(t)||v(N)>0?(x(),b("div",bt,[e("button",{onClick:Z,class:"text-vs-text-muted hover:text-red-400 text-sm transition-colors"}," Reset Voting ")])):(x(),b("div",ht,[e("div",_t,[S(v(xe),{size:64,"stroke-width":1.5,class:"text-vs-bar-accent animate-pulse"})]),a[18]||(a[18]=e("p",{class:"text-xl text-vs-text-muted"}," Waiting for participants... ",-1)),a[19]||(a[19]=e("p",{class:"text-sm text-vs-text-muted mt-2"}," Timer starts automatically with first vote or manually ",-1))]))])])):(x(),b("div",$e,[e("div",Ve,[e("h1",Ne,f(n.value?.title||"Loading..."),1),e("p",De,f(n.value?.description),1)]),e("div",Ue,[a[9]||(a[9]=e("h2",{class:"text-xl font-semibold mb-6"},"Room Setup",-1)),e("div",Me,[e("div",Oe,[e("label",Le,[q(e("input",{type:"radio","onUpdate:modelValue":a[0]||(a[0]=R=>l.value=R),value:"random",class:"w-5 h-5 text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-500 focus:ring-2"},null,512),[[J,l.value]]),a[5]||(a[5]=e("span",{class:"text-lg font-medium"},"Generate random room ID",-1))]),a[6]||(a[6]=e("p",{class:"text-vs-text-muted text-sm ml-11"}," A new random room ID will be created (e.g., ABC-123) ",-1))]),e("div",He,[e("label",Be,[q(e("input",{type:"radio","onUpdate:modelValue":a[1]||(a[1]=R=>l.value=R),value:"custom",class:"w-5 h-5 text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-500 focus:ring-2"},null,512),[[J,l.value]]),a[7]||(a[7]=e("span",{class:"text-lg font-medium"},"Enter existing room ID",-1))]),a[8]||(a[8]=e("p",{class:"text-vs-text-muted text-sm ml-11"}," Reuse a room ID you've already shared with participants ",-1)),l.value==="custom"?(x(),b("div",Fe,[q(e("input",{"onUpdate:modelValue":a[2]||(a[2]=R=>T.value=R),type:"text",placeholder:"e.g., ABC-123",class:"w-full px-4 py-3 bg-gray-800 border-2 border-gray-600 rounded-lg text-white font-mono text-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500 transition-colors",onInput:O,maxlength:"7"},null,544),[[le,T.value]]),w.value?(x(),b("p",ze,f(w.value),1)):M("",!0)])):M("",!0)]),e("div",je,[e("button",{onClick:L,class:"btn-primary w-full",disabled:_.value||l.value==="custom"&&!V.value},f(_.value?"Creating room...":"Create Room & Start Session"),9,Ye)])])])]))])])}}};export{wt as default};
