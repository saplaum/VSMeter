import{h as W,i as T,j as d,o as g,c as b,a as e,n as ee,t as _,e as te,k as j,b as R,w as se,l as B,v as q,m as oe,p as H,u as m,d as G,r as ae,q as le}from"./index-fjXN32cV.js";import{u as ne}from"./useVotingConfig-ut_cFHFv.js";import{C as S,M as w,$ as re,c as ie,_ as ue,a as ce,R as de,H as ve}from"./ResultChart-ywbKkXtW.js";function me(){const p="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let c="";for(let n=0;n<3;n++)c+=p.charAt(Math.floor(Math.random()*p.length));c+="-";for(let n=0;n<3;n++)c+=p.charAt(Math.floor(Math.random()*p.length));return c}function pe(p,c=null,n=null){const a=d(null),i=d(c||me()),f=T(()=>n?`${n}-${i.value}`:i.value),r=d(S.DISCONNECTED),v=d(new Map),x=d(new Map),h=T(()=>v.value.size),y=T(()=>x.value.size),E=T(()=>{const o={},s=p.value;return!s||!s.options||(s.options.forEach(C=>{o[C.label]=0}),x.value.forEach(C=>{o[C]!==void 0&&o[C]++})),o}),D=(o=null)=>new Promise((s,C)=>{try{o&&(i.value=o),r.value=S.CONNECTING,a.value=new re(f.value,{debug:2}),a.value.on("open",l=>{console.log("Host peer opened with ID:",l),r.value=S.CONNECTED,s(l)}),a.value.on("connection",l=>{console.log("Participant connected:",l.peer),v.value.set(l.peer,l),l.on("data",A=>{O(l.peer,A)}),l.on("close",()=>{console.log("Participant disconnected:",l.peer),v.value.delete(l.peer),x.value.delete(l.peer)}),l.on("error",A=>{console.error("Connection error:",A)})}),a.value.on("error",l=>{console.error("Peer error:",l),r.value=S.ERROR,C(l)})}catch(l){r.value=S.ERROR,C(l)}}),O=(o,s)=>{switch(console.log("Received message from",o,":",s),s.type){case w.VOTE:case w.VOTE_UPDATE:x.value.set(o,s.vote),N();break;case w.REQUEST_STATE:k(o);break}},N=()=>{const o={type:w.STATE_UPDATE,participantCount:h.value,voteCount:y.value};v.value.forEach(s=>{s.open&&s.send(o)})},U=(o,s)=>{const C={type:w.TIMER_UPDATE,timeRemaining:o,isActive:s};v.value.forEach(l=>{l.open&&l.send(C)})},P=()=>{const o={type:w.TIMER_START};v.value.forEach(s=>{s.open&&s.send(o)})},k=o=>{const s=v.value.get(o);s&&s.open&&s.send({type:w.STATE_UPDATE,participantCount:h.value,voteCount:y.value})},I=()=>{const o={type:w.RESULTS,results:E.value,totalVotes:y.value};console.log("Broadcasting results:",o),v.value.forEach(s=>{s.open&&s.send(o)})},L=()=>{x.value.clear();const o={type:w.RESET,timestamp:Date.now()};v.value.forEach(s=>{s.open&&s.send(o)})},$=()=>{a.value&&(a.value.destroy(),a.value=null),v.value.clear(),x.value.clear(),r.value=S.DISCONNECTED};return W(()=>{$()}),{peer:a,roomId:i,connectionStatus:r,peers:v,votes:x,participantCount:h,voteCount:y,results:E,initHost:D,broadcastResults:I,broadcastState:N,broadcastTimer:U,broadcastTimerStart:P,reset:L,destroy:$}}function fe(p){const c=d(p),n=d(!1),a=d(!1);let i=null;const f=()=>{n.value||(n.value=!0,c.value=p,i=setInterval(()=>{c.value--,c.value<=0&&r()},1e3))},r=()=>{n.value=!1,a.value=!0,i&&(clearInterval(i),i=null)},v=()=>{n.value=!1,a.value=!1,c.value=p,i&&(clearInterval(i),i=null)};return W(()=>{i&&clearInterval(i)}),{timeRemaining:c,isActive:n,isComplete:a,start:f,reset:v}}const xe=ie("rotate-ccw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),ge={class:"card"},be={class:"flex gap-3"},he=["value"],ye={__name:"ShareLink",props:{url:{type:String,required:!0}},setup(p){const c=p,n=d(!1),a=f=>{f.target.select()},i=async()=>{try{await navigator.clipboard.writeText(c.url),n.value=!0,setTimeout(()=>{n.value=!1},2e3)}catch(f){console.error("Failed to copy:",f)}};return(f,r)=>(g(),b("div",ge,[r[0]||(r[0]=e("h3",{class:"text-lg font-semibold mb-4"},"Share Voting Link",-1)),e("div",be,[e("input",{type:"text",value:p.url,readonly:"",class:"flex-1 bg-vs-dark border border-vs-border rounded-lg px-4 py-3 text-vs-text font-mono text-sm",onClick:a},null,8,he),e("button",{onClick:i,class:ee(["btn-primary whitespace-nowrap",{"opacity-50":n.value}])},_(n.value?"âœ“ Copied":"Copy"),3)]),r[1]||(r[1]=e("p",{class:"text-vs-text-muted text-sm mt-3"}," Share this link with all participants ",-1))]))}},_e={class:"min-h-screen bg-vs-dark p-8"},Ce={class:"max-w-5xl mx-auto"},we={key:0,class:"text-center py-12"},Te={key:1,class:"card text-center py-8"},Ee={class:"text-red-400 mb-4"},Re={key:2,class:"space-y-6"},ke={class:"mb-8"},Se={class:"text-3xl font-bold mb-2"},Ie={class:"text-vs-text-muted"},Ae={class:"card max-w-2xl mx-auto"},Ve={class:"space-y-6"},Me={class:"space-y-3"},De={class:"flex items-center space-x-3 cursor-pointer hover:bg-gray-800 p-3 rounded-lg transition-colors"},Ne={class:"space-y-3"},Ue={class:"flex items-center space-x-3 cursor-pointer hover:bg-gray-800 p-3 rounded-lg transition-colors"},$e={key:0,class:"ml-11 mt-3"},Oe={key:0,class:"text-red-400 text-sm mt-2"},Pe={class:"pt-4"},Le=["disabled"],Be={key:3},He={class:"mb-8"},ze={class:"flex items-center justify-between mb-4"},Fe={class:"text-3xl font-bold mb-2"},je={class:"text-vs-text-muted"},qe={class:"text-sm text-vs-text-muted"},Ge={class:"font-mono text-vs-bar-accent"},We={class:"space-y-6"},Ze={class:"card"},Qe={class:"flex items-center justify-between"},Ye={class:"text-3xl font-bold text-vs-bar-accent"},Je={key:0},Ke={key:1,class:"text-center"},Xe=["disabled"],et={class:"text-vs-text-muted text-sm mt-2"},tt={key:0,class:"space-y-6"},st={class:"card"},ot={class:"text-center"},at={key:1,class:"text-center"},lt={key:2,class:"card text-center py-12"},nt={class:"flex justify-center mb-4"},ct={__name:"HostView",props:{votingId:{type:String,required:!0}},setup(p){const c=p;le();const{loadVoting:n}=ne(),a=d(null),i=d(!0),f=d(null),r=d(!1),v=d(!1),x=d(!1),h=d("random"),y=d(""),E=d("");te(async()=>{try{a.value=await n(c.votingId),i.value=!1}catch(u){f.value=u.message||"Fehler beim Laden des Votings",i.value=!1}});const D=T(()=>{if(h.value==="random")return!0;const u=y.value.trim();return/^[A-Z0-9]{3}-[A-Z0-9]{3}$/.test(u)}),O=()=>{let u=y.value.toUpperCase().replace(/[^A-Z0-9-]/g,"");u.length>=3&&u[3]!=="-"&&(u=u.slice(0,3)+"-"+u.slice(3)),y.value=u.slice(0,7),y.value.length>0&&!D.value?E.value="Format: ABC-123 (3 characters, hyphen, 3 characters)":E.value=""},N=async()=>{if(!x.value){x.value=!0;try{const u=h.value==="custom"?y.value.trim():null;await $(u),v.value=!0}catch(u){f.value="Failed to create room: "+u.message}finally{x.value=!1}}},{roomId:U,connectionStatus:P,participantCount:k,voteCount:I,results:L,initHost:$,broadcastResults:o,broadcastTimer:s,broadcastTimerStart:C,reset:l}=pe(T(()=>a.value),null,c.votingId),A=T(()=>a.value?.delaySeconds||30),{timeRemaining:z,isActive:V,isComplete:Z,start:Q,reset:Y}=fe(A.value);j(z,u=>{V.value&&s(u,!0)});const J=()=>{!V.value&&!r.value&&(console.log("Manually starting timer"),Q(),C())};j(Z,u=>{u&&!r.value&&(console.log("Timer complete, revealing results"),r.value=!0,o())});const K=T(()=>typeof window>"u"?"":`${window.location.origin+"/VSMeter/"}vote/${c.votingId}/${U.value}`),F=()=>{confirm("Are you sure you want to reset the voting? All current votes will be lost.")&&(r.value=!1,Y(),l())};return(u,t)=>{const X=ae("router-link");return g(),b("div",_e,[e("div",Ce,[i.value?(g(),b("div",we,[...t[3]||(t[3]=[e("div",{class:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-vs-bar-mid"},null,-1),e("p",{class:"mt-4 text-vs-text-muted"},"Loading voting...",-1)])])):f.value?(g(),b("div",Te,[e("p",Ee,_(f.value),1),R(X,{to:"/",class:"btn-secondary"},{default:se(()=>[...t[4]||(t[4]=[G(" Back to Home ",-1)])]),_:1})])):v.value?(g(),b("div",Be,[e("header",He,[e("div",ze,[e("div",null,[e("h1",Fe,_(a.value?.title||"Loading..."),1),e("p",je,_(a.value?.description),1)]),R(ue,{status:m(P)},null,8,["status"])]),e("div",qe,[t[10]||(t[10]=G(" Room: ",-1)),e("span",Ge,_(m(U)),1)])]),e("div",We,[R(ye,{url:K.value},null,8,["url"]),e("div",Ze,[e("div",Qe,[e("div",null,[t[11]||(t[11]=e("h3",{class:"text-lg font-semibold mb-2"},"Participants",-1)),e("p",Ye,_(m(I))+" of "+_(m(k)),1),t[12]||(t[12]=e("p",{class:"text-vs-text-muted text-sm mt-1"},"have voted",-1))]),m(V)&&!r.value?(g(),b("div",Je,[R(ce,{seconds:m(z),message:"until results visible"},null,8,["seconds"])])):!m(V)&&!r.value?(g(),b("div",Ke,[e("button",{onClick:J,class:"btn-primary",disabled:m(k)===0}," Start Voting ",8,Xe),e("p",et,_(m(k)===0?"Waiting for participants...":`${m(k)} participants connected`),1)])):H("",!0)])]),r.value?(g(),b("div",tt,[e("div",st,[t[13]||(t[13]=e("h2",{class:"text-2xl font-bold mb-6 text-center"},"Results",-1)),R(de,{options:a.value.options,results:m(L),totalVotes:m(I)},null,8,["options","results","totalVotes"])]),e("div",ot,[e("button",{onClick:F,class:"bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 inline-flex items-center gap-2"},[R(m(xe),{size:20,"stroke-width":2}),t[14]||(t[14]=e("span",null,"Reset Voting & Start New Round",-1))]),t[15]||(t[15]=e("p",{class:"text-vs-text-muted text-sm mt-2"}," This will clear all votes and start a new voting session ",-1))])])):m(V)||m(I)>0?(g(),b("div",at,[e("button",{onClick:F,class:"text-vs-text-muted hover:text-red-400 text-sm transition-colors"}," Reset Voting ")])):(g(),b("div",lt,[e("div",nt,[R(m(ve),{size:64,"stroke-width":1.5,class:"text-vs-bar-accent animate-pulse"})]),t[16]||(t[16]=e("p",{class:"text-xl text-vs-text-muted"}," Waiting for participants... ",-1)),t[17]||(t[17]=e("p",{class:"text-sm text-vs-text-muted mt-2"}," Timer starts automatically with first vote or manually ",-1))]))])])):(g(),b("div",Re,[e("div",ke,[e("h1",Se,_(a.value?.title||"Loading..."),1),e("p",Ie,_(a.value?.description),1)]),e("div",Ae,[t[9]||(t[9]=e("h2",{class:"text-xl font-semibold mb-6"},"Room Setup",-1)),e("div",Ve,[e("div",Me,[e("label",De,[B(e("input",{type:"radio","onUpdate:modelValue":t[0]||(t[0]=M=>h.value=M),value:"random",class:"w-5 h-5 text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-500 focus:ring-2"},null,512),[[q,h.value]]),t[5]||(t[5]=e("span",{class:"text-lg font-medium"},"Generate random room ID",-1))]),t[6]||(t[6]=e("p",{class:"text-vs-text-muted text-sm ml-11"}," A new random room ID will be created (e.g., ABC-123) ",-1))]),e("div",Ne,[e("label",Ue,[B(e("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=M=>h.value=M),value:"custom",class:"w-5 h-5 text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-500 focus:ring-2"},null,512),[[q,h.value]]),t[7]||(t[7]=e("span",{class:"text-lg font-medium"},"Enter existing room ID",-1))]),t[8]||(t[8]=e("p",{class:"text-vs-text-muted text-sm ml-11"}," Reuse a room ID you've already shared with participants ",-1)),h.value==="custom"?(g(),b("div",$e,[B(e("input",{"onUpdate:modelValue":t[2]||(t[2]=M=>y.value=M),type:"text",placeholder:"e.g., ABC-123",class:"w-full px-4 py-3 bg-gray-800 border-2 border-gray-600 rounded-lg text-white font-mono text-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500 transition-colors",onInput:O,maxlength:"7"},null,544),[[oe,y.value]]),E.value?(g(),b("p",Oe,_(E.value),1)):H("",!0)])):H("",!0)]),e("div",Pe,[e("button",{onClick:N,class:"btn-primary w-full",disabled:x.value||h.value==="custom"&&!D.value},_(x.value?"Creating room...":"Create Room & Start Session"),9,Le)])])])]))])])}}};export{ct as default};
