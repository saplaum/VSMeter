import{h as G,j as v,o as d,c as p,a as n,t as b,n as H,k as F,e as Q,b as I,u as s,g as z,l as w,w as W,F as J,f as K,d as O,r as X,q as Z}from"./index-DgNT13AJ.js";import{u as ee}from"./useVotingConfig-BwJL3GnE.js";import{c as te,C as f,u as oe,M as g,$ as se,I as ne,_ as le,a as ae,H as Y,R as ie}from"./ResultChart-CQBWu7pw.js";const j=te("network",[["rect",{x:"16",y:"16",width:"6",height:"6",rx:"1",key:"4q2zg0"}],["rect",{x:"2",y:"16",width:"6",height:"6",rx:"1",key:"8cvhb9"}],["rect",{x:"9",y:"2",width:"6",height:"6",rx:"1",key:"1egb70"}],["path",{d:"M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3",key:"1jsf9p"}],["path",{d:"M12 12V8",key:"2874zd"}]]);function re(_){const i=v(null),a=v(null),r=v(f.DISCONNECTED),h=v(null),y=v(null),P=v(0),R=v(0),T=v(0),x=v(!1),k=oe(),c=v(null),C=v(new Map),E=v(0),A=20,N=v(null),D=()=>new Promise((o,e)=>{try{r.value=f.CONNECTING,i.value=new se({debug:2,config:ne}),i.value.on("open",t=>{console.log("Participant peer opened with ID:",t),V(o,e)}),i.value.on("error",t=>{console.error("Peer error:",t),r.value=f.ERROR,e(t)})}catch(t){r.value=f.ERROR,e(t)}}),V=(o,e)=>{a.value=i.value.connect(_);const t=setTimeout(()=>{r.value!==f.CONNECTED&&(console.log("Connection attempt timed out, retrying..."),$(o,e))},5e3);a.value.on("open",()=>{clearTimeout(t),console.log("Connected to host"),r.value=f.CONNECTED,E.value=0,a.value.send({type:g.REQUEST_STATE}),o(i.value.id)}),a.value.on("data",u=>{M(u)}),a.value.on("close",()=>{console.log("Connection to host closed"),!c.value||!c.value.open?r.value=f.DISCONNECTED:console.log("Still connected via relay")}),a.value.on("error",u=>{clearTimeout(t),console.error("Connection error:",u),$(o,e)})},$=(o,e)=>{if(E.value>=A){console.error("Max reconnection attempts reached"),r.value=f.ERROR,e(new Error("Could not connect to host after multiple attempts"));return}E.value++;const t=Math.min(1e3*Math.pow(1.5,E.value),1e4);console.log(`Reconnection attempt ${E.value}/${A} in ${Math.round(t/1e3)}s...`),r.value=f.CONNECTING,N.value=setTimeout(()=>{V(o,e)},t)},M=o=>{switch(console.log("Received message:",o),o.type){case g.STATE_UPDATE:P.value=o.participantCount||0,R.value=o.voteCount||0;break;case g.TIMER_UPDATE:T.value=o.timeRemaining||0,x.value=o.isActive||!1;break;case g.TIMER_START:x.value=!0;break;case g.RESULTS:y.value=o.results,x.value=!1;break;case g.RESET:h.value=null,y.value=null,P.value=0,R.value=0,T.value=0,x.value=!1;break;case g.ASSIGN_RELAY:m(o.payload);break;case g.RELAY_INFO:l(o.payload);break;case g.RELAY_BROADCAST:B(o.payload);break}},m=o=>{console.log("[Relay] Assigned as relay with config:",o),k.initializeAsRelay(a.value),i.value&&i.value.on("connection",e=>{console.log("[Relay] Participant connected:",e.peer),C.value.set(e.peer,e),e.on("data",t=>{console.log("[Relay] Received data from participant",e.peer,":",t),t.type===g.REQUEST_STATE&&(console.log(`[Relay] REQUEST_STATE received. Has originalPeerId? ${!!t.originalPeerId}`),t.originalPeerId&&(console.log(`[Relay] Participant ${e.peer} reports original PeerID: ${t.originalPeerId}`),console.log(`[Relay] DEBUG - Are they the same? ${e.peer===t.originalPeerId}`),a.value&&a.value.open?(console.log("[Relay] Sending RELAY_PARTICIPANT_CONNECTED to host"),a.value.send({type:g.RELAY_PARTICIPANT_CONNECTED,payload:{originalPeerId:t.originalPeerId,relayPeerId:e.peer}})):console.error("[Relay] Cannot send to host - connection not open!"))),console.log("[Relay] Forwarding message from",e.peer,":",t),k.forwardToHost(t,e.peer)}),e.on("close",()=>{console.log("[Relay] Participant disconnected:",e.peer),C.value.delete(e.peer)}),e.on("error",t=>{console.error("[Relay] Participant connection error:",t)})})},l=o=>{const{relayId:e,shouldConnectViaRelay:t}=o;if(!t){console.log("[Relay] No relay assignment, using direct connection");return}console.log("[Relay] Connecting to relay:",e),k.setAssignedRelay(e),c.value=i.value.connect(e),c.value.on("open",()=>{console.log("[Relay] Connected to relay successfully"),r.value=f.CONNECTED,a.value&&(console.log("[Relay] Closing direct connection to host (now using relay)"),a.value.close()),console.log("[Participant] Sending REQUEST_STATE to relay with originalPeerId:",i.value.id),c.value.send({type:g.REQUEST_STATE,originalPeerId:i.value.id})}),c.value.on("data",u=>{M(u)}),c.value.on("close",()=>{console.log("[Relay] Connection to relay closed"),r.value=f.DISCONNECTED,console.log("[Relay] Attempting to reconnect to host for relay reassignment..."),c.value=null,k.setAssignedRelay(null),setTimeout(()=>{(!a.value||!a.value.open)&&(console.log("[Relay] Reconnecting to host after relay disconnect..."),D().catch(u=>{console.error("[Relay] Failed to reconnect after relay disconnect:",u)}))},1e3)}),c.value.on("error",u=>{console.error("[Relay] Connection error:",u),r.value=f.ERROR})},B=o=>{const{originalMessage:e,targetParticipants:t}=o;console.log("[Relay] Broadcasting to",t.length,"participants:",t),console.log("[Relay] Available connections:",Array.from(C.value.keys())),t.forEach(u=>{const L=C.value.get(u);if(L&&L.open)try{console.log("[Relay] Forwarding message to",u,":",e),L.send(e)}catch(q){console.error(`[Relay] Failed to forward to ${u}:`,q)}else console.warn(`[Relay] No connection found for participant ${u}`)})},S=o=>{const e=c.value||a.value;if(!e||!e.open){console.error("Not connected to host or relay");return}const t=h.value!==null;h.value=o;const u={type:t?g.VOTE_UPDATE:g.VOTE,peerId:i.value?.id,vote:o,timestamp:Date.now()};console.log("Sending vote:",u,c.value?"(via relay)":"(direct)"),e.send(u)},U=()=>{N.value&&(clearTimeout(N.value),N.value=null),c.value&&(c.value.close(),c.value=null),C.value.forEach(o=>{o&&o.close()}),C.value.clear(),a.value&&(a.value.close(),a.value=null),i.value&&(i.value.destroy(),i.value=null),k.reset(),r.value=f.DISCONNECTED,E.value=0};return G(()=>{U()}),{peer:i,connection:a,connectionStatus:r,myVote:h,results:y,participantCount:P,voteCount:R,timeRemaining:T,timerActive:x,reconnectAttempts:E,connect:D,vote:S,destroy:U,relayNetwork:k,relayConnection:c,relayedParticipants:C}}const ce=["disabled"],ue={class:"text-4xl"},de={class:"text-sm font-medium text-center"},ve={__name:"VotingOption",props:{option:{type:Object,required:!0},selected:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["select"],setup(_){return(i,a)=>(d(),p("button",{class:H(["voting-option",{selected:_.selected,disabled:_.disabled}]),onClick:a[0]||(a[0]=r=>i.$emit("select",_.option.label)),disabled:_.disabled},[n("span",ue,b(_.option.emoji),1),n("span",de,b(_.option.label),1)],10,ce))}},me={class:"min-h-screen bg-vs-dark p-8"},ge={class:"max-w-6xl mx-auto"},pe={class:"mb-8 text-center"},ye={class:"text-3xl font-bold mb-2"},fe={class:"text-vs-text-muted mb-4"},he={class:"flex flex-col items-center gap-3"},Re={key:0,class:"text-center py-12"},xe={class:"mt-4 text-lg text-vs-text-muted"},Ee={key:0,class:"mt-2 text-sm text-vs-text-muted"},_e={key:1,class:"mt-4 text-sm text-amber-400"},be={key:1,class:"card text-center py-8"},Ce={class:"mb-6"},Te={class:"inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-900/30 mb-4"},ke={class:"text-vs-text-muted mb-4"},Ae={class:"flex gap-3 justify-center"},Ne={key:2,class:"space-y-6"},Se={class:"card"},Ie={class:"flex justify-center gap-3 flex-nowrap overflow-x-auto"},we={key:0,class:"mt-6 text-center"},Pe={class:"flex items-center justify-center gap-2 text-vs-text-muted text-lg"},Ve={key:0,class:"card text-center"},Oe={class:"text-vs-text-muted"},De={class:"text-vs-bar-accent font-semibold"},$e={class:"text-center text-vs-text-muted text-sm"},Me={key:0},Ue={key:1,class:"text-blue-400 mt-2 flex items-center justify-center gap-2"},Be={key:2,class:"text-blue-400 mt-2 flex items-center justify-center gap-2"},Le={key:3,class:"space-y-6"},Fe={class:"card"},qe={__name:"VoteView",props:{votingId:{type:String,required:!0},roomId:{type:String,required:!0}},setup(_){const i=_;Z();const{loadVoting:a}=ee(),r=v(null),h=v(!0),y=v(null),P=`${i.votingId}-${i.roomId}`,{connectionStatus:R,myVote:T,results:x,participantCount:k,voteCount:c,timeRemaining:C,timerActive:E,reconnectAttempts:A,connect:N,vote:D,relayNetwork:V}=re(P);F(R,m=>{m==="connected"?(y.value=null,h.value=!1):m==="error"&&A.value>=20&&(y.value="The host has not opened this room yet. Please check the room ID or try again later.",h.value=!1)}),Q(async()=>{try{r.value=await a(i.votingId),N().catch(m=>{R.value!=="connecting"&&(y.value=m.message||"Fehler beim Verbinden")}),h.value=!1}catch(m){y.value=m.message||"Fehler beim Laden des Votings",h.value=!1}});const $=m=>{D(m)},M=()=>{y.value=null,h.value=!0,N().catch(m=>{R.value!=="connecting"&&(y.value=m.message||"Connection failed")})};return F(x,(m,l)=>{l&&!m&&console.log("Voting has been reset")}),(m,l)=>{const B=X("router-link");return d(),p("div",me,[n("div",ge,[n("header",pe,[n("h1",ye,b(r.value?.title||"Loading..."),1),n("p",fe,b(r.value?.description),1),n("div",he,[I(le,{status:s(R)},null,8,["status"]),s(E)&&!s(x)?(d(),z(ae,{key:0,seconds:s(C),message:"until results visible"},null,8,["seconds"])):w("",!0)])]),h.value||s(R)==="connecting"&&!y.value?(d(),p("div",Re,[l[0]||(l[0]=n("div",{class:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-vs-bar-mid"},null,-1)),n("p",xe,b(s(A)>0?"Waiting for host to open the room...":"Connecting..."),1),s(A)>0?(d(),p("p",Ee," Attempting to connect ("+b(s(A))+"/20) ",1)):w("",!0),s(A)>10?(d(),p("p",_e," Still waiting... Make sure the host has opened this room. ")):w("",!0)])):y.value?(d(),p("div",be,[n("div",Ce,[n("div",Te,[I(s(Y),{size:32,"stroke-width":2,class:"text-red-400"})]),l[1]||(l[1]=n("h3",{class:"text-xl font-semibold mb-2"},"Room Not Available",-1)),n("p",ke,b(y.value),1)]),n("div",Ae,[n("button",{onClick:M,class:"btn-primary"}," Try Again "),I(B,{to:"/",class:"btn-secondary"},{default:W(()=>[...l[2]||(l[2]=[O(" Back to Home ",-1)])]),_:1})])])):s(x)?(d(),p("div",Le,[n("div",Fe,[l[10]||(l[10]=n("h2",{class:"text-2xl font-bold mb-6 text-center"},"Results",-1)),I(ie,{options:r.value.options,results:s(x),totalVotes:Object.values(s(x)).reduce((S,U)=>S+U,0),myVote:s(T)},null,8,["options","results","totalVotes","myVote"])]),l[11]||(l[11]=n("div",{class:"text-center text-vs-text-muted text-sm"},[n("p",null,"Voting completed")],-1))])):(d(),p("div",Ne,[n("div",Se,[l[4]||(l[4]=n("h2",{class:"text-xl font-semibold mb-6 text-center"},"Choose your option:",-1)),n("div",Ie,[(d(!0),p(J,null,K(r.value.options,S=>(d(),z(ve,{key:S.label,option:S,selected:s(T)===S.label,disabled:s(R)!=="connected"||!s(E),onSelect:$},null,8,["option","selected","disabled"]))),128))]),!s(E)&&s(R)==="connected"?(d(),p("div",we,[n("div",Pe,[I(s(Y),{size:20,"stroke-width":2,class:"animate-pulse"}),l[3]||(l[3]=n("span",null,"Waiting for host to start voting...",-1))])])):w("",!0)]),s(T)?(d(),p("div",Ve,[n("p",Oe,[l[5]||(l[5]=O(" Your choice: ",-1)),n("span",De,b(s(T)),1),l[6]||(l[6]=O(" âœ“ ",-1))]),l[7]||(l[7]=n("p",{class:"text-sm text-vs-text-muted mt-2"}," You can still change your vote ",-1))])):w("",!0),n("div",$e,[n("p",null,b(s(k))+" participants connected",1),s(c)>0?(d(),p("p",Me,b(s(c))+" have already voted",1)):w("",!0),s(V)?.isRelay.value?(d(),p("p",Ue,[I(s(j),{size:16}),l[8]||(l[8]=O(" Acting as relay (supporting scaled voting) ",-1))])):s(V)?.assignedRelayId.value?(d(),p("p",Be,[I(s(j),{size:16}),l[9]||(l[9]=O(" Connected via relay ",-1))])):w("",!0)])]))])])}}};export{qe as default};
