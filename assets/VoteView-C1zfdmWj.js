import{h as U,j as u,o as c,c as d,a as s,t as g,n as B,k as $,e as j,b as V,u as o,g as D,p as E,w as q,F,f as L,d as O,r as z,q as G}from"./index-fjXN32cV.js";import{u as H}from"./useVotingConfig-ut_cFHFv.js";import{C as f,M as C,$ as W,_ as Y,a as Q,H as M,R as J}from"./ResultChart-ywbKkXtW.js";function K(x){const i=u(null),n=u(null),l=u(f.DISCONNECTED),v=u(null),r=u(null),k=u(0),m=u(0),_=u(0),p=u(!1),h=u(0),R=20,T=u(null),N=()=>new Promise((t,e)=>{try{l.value=f.CONNECTING,i.value=new W({debug:2}),i.value.on("open",a=>{console.log("Participant peer opened with ID:",a),y(t,e)}),i.value.on("error",a=>{console.error("Peer error:",a),l.value=f.ERROR,e(a)})}catch(a){l.value=f.ERROR,e(a)}}),y=(t,e)=>{n.value=i.value.connect(x);const a=setTimeout(()=>{l.value!==f.CONNECTED&&(console.log("Connection attempt timed out, retrying..."),S(t,e))},5e3);n.value.on("open",()=>{clearTimeout(a),console.log("Connected to host"),l.value=f.CONNECTED,h.value=0,n.value.send({type:C.REQUEST_STATE}),t(i.value.id)}),n.value.on("data",b=>{A(b)}),n.value.on("close",()=>{console.log("Connection to host closed"),l.value=f.DISCONNECTED}),n.value.on("error",b=>{clearTimeout(a),console.error("Connection error:",b),S(t,e)})},S=(t,e)=>{if(h.value>=R){console.error("Max reconnection attempts reached"),l.value=f.ERROR,e(new Error("Could not connect to host after multiple attempts"));return}h.value++;const a=Math.min(1e3*Math.pow(1.5,h.value),1e4);console.log(`Reconnection attempt ${h.value}/${R} in ${Math.round(a/1e3)}s...`),l.value=f.CONNECTING,T.value=setTimeout(()=>{y(t,e)},a)},A=t=>{switch(console.log("Received message:",t),t.type){case C.STATE_UPDATE:k.value=t.participantCount||0,m.value=t.voteCount||0;break;case C.TIMER_UPDATE:_.value=t.timeRemaining||0,p.value=t.isActive||!1;break;case C.TIMER_START:p.value=!0;break;case C.RESULTS:r.value=t.results,p.value=!1;break;case C.RESET:v.value=null,r.value=null,k.value=0,m.value=0,_.value=0,p.value=!1;break}},I=t=>{if(!n.value||!n.value.open){console.error("Not connected to host");return}const e=v.value!==null;v.value=t;const a={type:e?C.VOTE_UPDATE:C.VOTE,peerId:i.value?.id,vote:t,timestamp:Date.now()};console.log("Sending vote:",a),n.value.send(a)},w=()=>{T.value&&(clearTimeout(T.value),T.value=null),n.value&&(n.value.close(),n.value=null),i.value&&(i.value.destroy(),i.value=null),l.value=f.DISCONNECTED,h.value=0};return U(()=>{w()}),{peer:i,connection:n,connectionStatus:l,myVote:v,results:r,participantCount:k,voteCount:m,timeRemaining:_,timerActive:p,reconnectAttempts:h,connect:N,vote:I,destroy:w}}const X=["disabled"],Z={class:"text-4xl"},ee={class:"text-sm font-medium text-center"},te={__name:"VotingOption",props:{option:{type:Object,required:!0},selected:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["select"],setup(x){return(i,n)=>(c(),d("button",{class:B(["voting-option",{selected:x.selected,disabled:x.disabled}]),onClick:n[0]||(n[0]=l=>i.$emit("select",x.option.label)),disabled:x.disabled},[s("span",Z,g(x.option.emoji),1),s("span",ee,g(x.option.label),1)],10,X))}},se={class:"min-h-screen bg-vs-dark p-8"},oe={class:"max-w-6xl mx-auto"},ne={class:"mb-8 text-center"},le={class:"text-3xl font-bold mb-2"},ae={class:"text-vs-text-muted mb-4"},ie={class:"flex flex-col items-center gap-3"},ce={key:0,class:"text-center py-12"},ue={class:"mt-4 text-lg text-vs-text-muted"},re={key:0,class:"mt-2 text-sm text-vs-text-muted"},de={key:1,class:"mt-4 text-sm text-amber-400"},ve={key:1,class:"card text-center py-8"},me={class:"mb-6"},pe={class:"inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-900/30 mb-4"},xe={class:"text-vs-text-muted mb-4"},fe={class:"flex gap-3 justify-center"},ge={key:2,class:"space-y-6"},he={class:"card"},be={class:"flex justify-center gap-3 flex-nowrap overflow-x-auto"},_e={key:0,class:"mt-6 text-center"},ye={class:"flex items-center justify-center gap-2 text-vs-text-muted text-lg"},Ce={key:0,class:"card text-center"},Te={class:"text-vs-text-muted"},Ee={class:"text-vs-bar-accent font-semibold"},ke={class:"text-center text-vs-text-muted text-sm"},Re={key:0},Ne={key:3,class:"space-y-6"},Se={class:"card"},Ie={__name:"VoteView",props:{votingId:{type:String,required:!0},roomId:{type:String,required:!0}},setup(x){const i=x;G();const{loadVoting:n}=H(),l=u(null),v=u(!0),r=u(null),k=`${i.votingId}-${i.roomId}`,{connectionStatus:m,myVote:_,results:p,participantCount:h,voteCount:R,timeRemaining:T,timerActive:N,reconnectAttempts:y,connect:S,vote:A}=K(k);$(m,t=>{t==="connected"?(r.value=null,v.value=!1):t==="error"&&y.value>=20&&(r.value="The host has not opened this room yet. Please check the room ID or try again later.",v.value=!1)}),j(async()=>{try{l.value=await n(i.votingId),S().catch(t=>{m.value!=="connecting"&&(r.value=t.message||"Fehler beim Verbinden")}),v.value=!1}catch(t){r.value=t.message||"Fehler beim Laden des Votings",v.value=!1}});const I=t=>{A(t)},w=()=>{r.value=null,v.value=!0,S().catch(t=>{m.value!=="connecting"&&(r.value=t.message||"Connection failed")})};return $(p,(t,e)=>{e&&!t&&console.log("Voting has been reset")}),(t,e)=>{const a=z("router-link");return c(),d("div",se,[s("div",oe,[s("header",ne,[s("h1",le,g(l.value?.title||"Loading..."),1),s("p",ae,g(l.value?.description),1),s("div",ie,[V(Y,{status:o(m)},null,8,["status"]),o(N)&&!o(p)?(c(),D(Q,{key:0,seconds:o(T),message:"until results visible"},null,8,["seconds"])):E("",!0)])]),v.value||o(m)==="connecting"&&!r.value?(c(),d("div",ce,[e[0]||(e[0]=s("div",{class:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-vs-bar-mid"},null,-1)),s("p",ue,g(o(y)>0?"Waiting for host to open the room...":"Connecting..."),1),o(y)>0?(c(),d("p",re," Attempting to connect ("+g(o(y))+"/20) ",1)):E("",!0),o(y)>10?(c(),d("p",de," Still waiting... Make sure the host has opened this room. ")):E("",!0)])):r.value?(c(),d("div",ve,[s("div",me,[s("div",pe,[V(o(M),{size:32,"stroke-width":2,class:"text-red-400"})]),e[1]||(e[1]=s("h3",{class:"text-xl font-semibold mb-2"},"Room Not Available",-1)),s("p",xe,g(r.value),1)]),s("div",fe,[s("button",{onClick:w,class:"btn-primary"}," Try Again "),V(a,{to:"/",class:"btn-secondary"},{default:q(()=>[...e[2]||(e[2]=[O(" Back to Home ",-1)])]),_:1})])])):o(p)?(c(),d("div",Ne,[s("div",Se,[e[8]||(e[8]=s("h2",{class:"text-2xl font-bold mb-6 text-center"},"Results",-1)),V(J,{options:l.value.options,results:o(p),totalVotes:Object.values(o(p)).reduce((b,P)=>b+P,0),myVote:o(_)},null,8,["options","results","totalVotes","myVote"])]),e[9]||(e[9]=s("div",{class:"text-center text-vs-text-muted text-sm"},[s("p",null,"Voting completed")],-1))])):(c(),d("div",ge,[s("div",he,[e[4]||(e[4]=s("h2",{class:"text-xl font-semibold mb-6 text-center"},"Choose your option:",-1)),s("div",be,[(c(!0),d(F,null,L(l.value.options,b=>(c(),D(te,{key:b.label,option:b,selected:o(_)===b.label,disabled:o(m)!=="connected"||!o(N),onSelect:I},null,8,["option","selected","disabled"]))),128))]),!o(N)&&o(m)==="connected"?(c(),d("div",_e,[s("div",ye,[V(o(M),{size:20,"stroke-width":2,class:"animate-pulse"}),e[3]||(e[3]=s("span",null,"Waiting for host to start voting...",-1))])])):E("",!0)]),o(_)?(c(),d("div",Ce,[s("p",Te,[e[5]||(e[5]=O(" Your choice: ",-1)),s("span",Ee,g(o(_)),1),e[6]||(e[6]=O(" âœ“ ",-1))]),e[7]||(e[7]=s("p",{class:"text-sm text-vs-text-muted mt-2"}," You can still change your vote ",-1))])):E("",!0),s("div",ke,[s("p",null,g(o(h))+" participants connected",1),o(R)>0?(c(),d("p",Re,g(o(R))+" have already voted",1)):E("",!0)])]))])])}}};export{Ie as default};
