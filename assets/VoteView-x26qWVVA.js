import{h as G,j as v,o as d,c as g,a as n,t as E,n as H,k as F,e as Q,b as w,u as s,g as z,l as I,w as W,F as J,f as K,d as V,r as X,q as Z}from"./index-1lFQlLdV.js";import{u as ee}from"./useVotingConfig-Btj-aSr9.js";import{c as te,C as f,u as oe,M as p,$ as se,_ as ne,a as le,H as Y,R as ae}from"./ResultChart-ChxGdnTw.js";const j=te("network",[["rect",{x:"16",y:"16",width:"6",height:"6",rx:"1",key:"4q2zg0"}],["rect",{x:"2",y:"16",width:"6",height:"6",rx:"1",key:"8cvhb9"}],["rect",{x:"9",y:"2",width:"6",height:"6",rx:"1",key:"1egb70"}],["path",{d:"M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3",key:"1jsf9p"}],["path",{d:"M12 12V8",key:"2874zd"}]]);function ie(b){const i=v(null),a=v(null),r=v(f.DISCONNECTED),h=v(null),y=v(null),P=v(0),R=v(0),T=v(0),x=v(!1),k=oe(),c=v(null),C=v(new Map),_=v(0),A=20,N=v(null),D=()=>new Promise((o,e)=>{try{r.value=f.CONNECTING,i.value=new se({debug:2}),i.value.on("open",t=>{console.log("Participant peer opened with ID:",t),O(o,e)}),i.value.on("error",t=>{console.error("Peer error:",t),r.value=f.ERROR,e(t)})}catch(t){r.value=f.ERROR,e(t)}}),O=(o,e)=>{a.value=i.value.connect(b);const t=setTimeout(()=>{r.value!==f.CONNECTED&&(console.log("Connection attempt timed out, retrying..."),$(o,e))},5e3);a.value.on("open",()=>{clearTimeout(t),console.log("Connected to host"),r.value=f.CONNECTED,_.value=0,a.value.send({type:p.REQUEST_STATE}),o(i.value.id)}),a.value.on("data",u=>{M(u)}),a.value.on("close",()=>{console.log("Connection to host closed"),!c.value||!c.value.open?r.value=f.DISCONNECTED:console.log("Still connected via relay")}),a.value.on("error",u=>{clearTimeout(t),console.error("Connection error:",u),$(o,e)})},$=(o,e)=>{if(_.value>=A){console.error("Max reconnection attempts reached"),r.value=f.ERROR,e(new Error("Could not connect to host after multiple attempts"));return}_.value++;const t=Math.min(1e3*Math.pow(1.5,_.value),1e4);console.log(`Reconnection attempt ${_.value}/${A} in ${Math.round(t/1e3)}s...`),r.value=f.CONNECTING,N.value=setTimeout(()=>{O(o,e)},t)},M=o=>{switch(console.log("Received message:",o),o.type){case p.STATE_UPDATE:P.value=o.participantCount||0,R.value=o.voteCount||0;break;case p.TIMER_UPDATE:T.value=o.timeRemaining||0,x.value=o.isActive||!1;break;case p.TIMER_START:x.value=!0;break;case p.RESULTS:y.value=o.results,x.value=!1;break;case p.RESET:h.value=null,y.value=null,P.value=0,R.value=0,T.value=0,x.value=!1;break;case p.ASSIGN_RELAY:m(o.payload);break;case p.RELAY_INFO:l(o.payload);break;case p.RELAY_BROADCAST:B(o.payload);break}},m=o=>{console.log("[Relay] Assigned as relay with config:",o),k.initializeAsRelay(a.value),i.value&&i.value.on("connection",e=>{console.log("[Relay] Participant connected:",e.peer),C.value.set(e.peer,e),e.on("data",t=>{console.log("[Relay] Received data from participant",e.peer,":",t),t.type===p.REQUEST_STATE&&(console.log(`[Relay] REQUEST_STATE received. Has originalPeerId? ${!!t.originalPeerId}`),t.originalPeerId&&(console.log(`[Relay] Participant ${e.peer} reports original PeerID: ${t.originalPeerId}`),console.log(`[Relay] DEBUG - Are they the same? ${e.peer===t.originalPeerId}`),a.value&&a.value.open?(console.log("[Relay] Sending RELAY_PARTICIPANT_CONNECTED to host"),a.value.send({type:p.RELAY_PARTICIPANT_CONNECTED,payload:{originalPeerId:t.originalPeerId,relayPeerId:e.peer}})):console.error("[Relay] Cannot send to host - connection not open!"))),console.log("[Relay] Forwarding message from",e.peer,":",t),k.forwardToHost(t,e.peer)}),e.on("close",()=>{console.log("[Relay] Participant disconnected:",e.peer),C.value.delete(e.peer)}),e.on("error",t=>{console.error("[Relay] Participant connection error:",t)})})},l=o=>{const{relayId:e,shouldConnectViaRelay:t}=o;if(!t){console.log("[Relay] No relay assignment, using direct connection");return}console.log("[Relay] Connecting to relay:",e),k.setAssignedRelay(e),c.value=i.value.connect(e),c.value.on("open",()=>{console.log("[Relay] Connected to relay successfully"),r.value=f.CONNECTED,a.value&&(console.log("[Relay] Closing direct connection to host (now using relay)"),a.value.close()),console.log("[Participant] Sending REQUEST_STATE to relay with originalPeerId:",i.value.id),c.value.send({type:p.REQUEST_STATE,originalPeerId:i.value.id})}),c.value.on("data",u=>{M(u)}),c.value.on("close",()=>{console.log("[Relay] Connection to relay closed"),r.value=f.DISCONNECTED,console.log("[Relay] Attempting to reconnect to host for relay reassignment..."),c.value=null,k.setAssignedRelay(null),setTimeout(()=>{(!a.value||!a.value.open)&&(console.log("[Relay] Reconnecting to host after relay disconnect..."),D().catch(u=>{console.error("[Relay] Failed to reconnect after relay disconnect:",u)}))},1e3)}),c.value.on("error",u=>{console.error("[Relay] Connection error:",u),r.value=f.ERROR})},B=o=>{const{originalMessage:e,targetParticipants:t}=o;console.log("[Relay] Broadcasting to",t.length,"participants:",t),console.log("[Relay] Available connections:",Array.from(C.value.keys())),t.forEach(u=>{const L=C.value.get(u);if(L&&L.open)try{console.log("[Relay] Forwarding message to",u,":",e),L.send(e)}catch(q){console.error(`[Relay] Failed to forward to ${u}:`,q)}else console.warn(`[Relay] No connection found for participant ${u}`)})},S=o=>{const e=c.value||a.value;if(!e||!e.open){console.error("Not connected to host or relay");return}const t=h.value!==null;h.value=o;const u={type:t?p.VOTE_UPDATE:p.VOTE,peerId:i.value?.id,vote:o,timestamp:Date.now()};console.log("Sending vote:",u,c.value?"(via relay)":"(direct)"),e.send(u)},U=()=>{N.value&&(clearTimeout(N.value),N.value=null),c.value&&(c.value.close(),c.value=null),C.value.forEach(o=>{o&&o.close()}),C.value.clear(),a.value&&(a.value.close(),a.value=null),i.value&&(i.value.destroy(),i.value=null),k.reset(),r.value=f.DISCONNECTED,_.value=0};return G(()=>{U()}),{peer:i,connection:a,connectionStatus:r,myVote:h,results:y,participantCount:P,voteCount:R,timeRemaining:T,timerActive:x,reconnectAttempts:_,connect:D,vote:S,destroy:U,relayNetwork:k,relayConnection:c,relayedParticipants:C}}const re=["disabled"],ce={class:"text-4xl"},ue={class:"text-sm font-medium text-center"},de={__name:"VotingOption",props:{option:{type:Object,required:!0},selected:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["select"],setup(b){return(i,a)=>(d(),g("button",{class:H(["voting-option",{selected:b.selected,disabled:b.disabled}]),onClick:a[0]||(a[0]=r=>i.$emit("select",b.option.label)),disabled:b.disabled},[n("span",ce,E(b.option.emoji),1),n("span",ue,E(b.option.label),1)],10,re))}},ve={class:"min-h-screen bg-vs-dark p-8"},me={class:"max-w-6xl mx-auto"},pe={class:"mb-8 text-center"},ge={class:"text-3xl font-bold mb-2"},ye={class:"text-vs-text-muted mb-4"},fe={class:"flex flex-col items-center gap-3"},he={key:0,class:"text-center py-12"},Re={class:"mt-4 text-lg text-vs-text-muted"},xe={key:0,class:"mt-2 text-sm text-vs-text-muted"},_e={key:1,class:"mt-4 text-sm text-amber-400"},be={key:1,class:"card text-center py-8"},Ee={class:"mb-6"},Ce={class:"inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-900/30 mb-4"},Te={class:"text-vs-text-muted mb-4"},ke={class:"flex gap-3 justify-center"},Ae={key:2,class:"space-y-6"},Ne={class:"card"},Se={class:"flex justify-center gap-3 flex-nowrap overflow-x-auto"},we={key:0,class:"mt-6 text-center"},Ie={class:"flex items-center justify-center gap-2 text-vs-text-muted text-lg"},Pe={key:0,class:"card text-center"},Oe={class:"text-vs-text-muted"},Ve={class:"text-vs-bar-accent font-semibold"},De={class:"text-center text-vs-text-muted text-sm"},$e={key:0},Me={key:1,class:"text-blue-400 mt-2 flex items-center justify-center gap-2"},Ue={key:2,class:"text-blue-400 mt-2 flex items-center justify-center gap-2"},Be={key:3,class:"space-y-6"},Le={class:"card"},je={__name:"VoteView",props:{votingId:{type:String,required:!0},roomId:{type:String,required:!0}},setup(b){const i=b;Z();const{loadVoting:a}=ee(),r=v(null),h=v(!0),y=v(null),P=`${i.votingId}-${i.roomId}`,{connectionStatus:R,myVote:T,results:x,participantCount:k,voteCount:c,timeRemaining:C,timerActive:_,reconnectAttempts:A,connect:N,vote:D,relayNetwork:O}=ie(P);F(R,m=>{m==="connected"?(y.value=null,h.value=!1):m==="error"&&A.value>=20&&(y.value="The host has not opened this room yet. Please check the room ID or try again later.",h.value=!1)}),Q(async()=>{try{r.value=await a(i.votingId),N().catch(m=>{R.value!=="connecting"&&(y.value=m.message||"Fehler beim Verbinden")}),h.value=!1}catch(m){y.value=m.message||"Fehler beim Laden des Votings",h.value=!1}});const $=m=>{D(m)},M=()=>{y.value=null,h.value=!0,N().catch(m=>{R.value!=="connecting"&&(y.value=m.message||"Connection failed")})};return F(x,(m,l)=>{l&&!m&&console.log("Voting has been reset")}),(m,l)=>{const B=X("router-link");return d(),g("div",ve,[n("div",me,[n("header",pe,[n("h1",ge,E(r.value?.title||"Loading..."),1),n("p",ye,E(r.value?.description),1),n("div",fe,[w(ne,{status:s(R)},null,8,["status"]),s(_)&&!s(x)?(d(),z(le,{key:0,seconds:s(C),message:"until results visible"},null,8,["seconds"])):I("",!0)])]),h.value||s(R)==="connecting"&&!y.value?(d(),g("div",he,[l[0]||(l[0]=n("div",{class:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-vs-bar-mid"},null,-1)),n("p",Re,E(s(A)>0?"Waiting for host to open the room...":"Connecting..."),1),s(A)>0?(d(),g("p",xe," Attempting to connect ("+E(s(A))+"/20) ",1)):I("",!0),s(A)>10?(d(),g("p",_e," Still waiting... Make sure the host has opened this room. ")):I("",!0)])):y.value?(d(),g("div",be,[n("div",Ee,[n("div",Ce,[w(s(Y),{size:32,"stroke-width":2,class:"text-red-400"})]),l[1]||(l[1]=n("h3",{class:"text-xl font-semibold mb-2"},"Room Not Available",-1)),n("p",Te,E(y.value),1)]),n("div",ke,[n("button",{onClick:M,class:"btn-primary"}," Try Again "),w(B,{to:"/",class:"btn-secondary"},{default:W(()=>[...l[2]||(l[2]=[V(" Back to Home ",-1)])]),_:1})])])):s(x)?(d(),g("div",Be,[n("div",Le,[l[10]||(l[10]=n("h2",{class:"text-2xl font-bold mb-6 text-center"},"Results",-1)),w(ae,{options:r.value.options,results:s(x),totalVotes:Object.values(s(x)).reduce((S,U)=>S+U,0),myVote:s(T)},null,8,["options","results","totalVotes","myVote"])]),l[11]||(l[11]=n("div",{class:"text-center text-vs-text-muted text-sm"},[n("p",null,"Voting completed")],-1))])):(d(),g("div",Ae,[n("div",Ne,[l[4]||(l[4]=n("h2",{class:"text-xl font-semibold mb-6 text-center"},"Choose your option:",-1)),n("div",Se,[(d(!0),g(J,null,K(r.value.options,S=>(d(),z(de,{key:S.label,option:S,selected:s(T)===S.label,disabled:s(R)!=="connected"||!s(_),onSelect:$},null,8,["option","selected","disabled"]))),128))]),!s(_)&&s(R)==="connected"?(d(),g("div",we,[n("div",Ie,[w(s(Y),{size:20,"stroke-width":2,class:"animate-pulse"}),l[3]||(l[3]=n("span",null,"Waiting for host to start voting...",-1))])])):I("",!0)]),s(T)?(d(),g("div",Pe,[n("p",Oe,[l[5]||(l[5]=V(" Your choice: ",-1)),n("span",Ve,E(s(T)),1),l[6]||(l[6]=V(" âœ“ ",-1))]),l[7]||(l[7]=n("p",{class:"text-sm text-vs-text-muted mt-2"}," You can still change your vote ",-1))])):I("",!0),n("div",De,[n("p",null,E(s(k))+" participants connected",1),s(c)>0?(d(),g("p",$e,E(s(c))+" have already voted",1)):I("",!0),s(O)?.isRelay.value?(d(),g("p",Me,[w(s(j),{size:16}),l[8]||(l[8]=V(" Acting as relay (supporting scaled voting) ",-1))])):s(O)?.assignedRelayId.value?(d(),g("p",Ue,[w(s(j),{size:16}),l[9]||(l[9]=V(" Connected via relay ",-1))])):I("",!0)])]))])])}}};export{je as default};
